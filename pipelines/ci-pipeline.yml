trigger:
  batch: true
  branches:
    include:
    - main
    - release
  paths:
    exclude:
    - pipelines/*
    - '*.md'
    - .github/workflows
pr:
  autoCancel: true # indicates whether additional pushes to a PR should cancel in-progress runs for the same PR. Defaults to true
  branches:
    include:
    - main
  drafts: false # whether to build draft PRs, defaults to true
  paths:
    exclude:
    - pipelines/*
    - '*.md'
    - .github/workflows

parameters:
- name: test
  displayName: Run Tests?
  type: boolean
  default: true

variables:
  - name: tag
    value: '$(Build.BuildId)'
  - group: devops-framework-backend-global
  - name: prSourceBranch
    value: 'System.PullRequest.SourceBranch'
  - name: prNumber
    value: 'System.PullRequest.PullRequestNumber'

stages:
- stage: 'Build'
  displayName: 'Build the web application'
  jobs: 
  - template: templates/build.yaml
    parameters:
      test: ${{ parameters.test }}

- ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
  - stage: DeployPR
    displayName: 'Deploy to the temporary PR environment'
    dependsOn: Build
    jobs:
    - template: templates/deploy-kubernetes-pr.yaml
      parameters:
        environment: pr
        namespace: ${{ format('{0}-{1}', replace(variables['prSourceBranch'], '/', '-'), variables['prNumber']) }}

- ${{ if and(ne(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.SourceBranchName'], 'main')) }}:
  - stage: DeployDev
    displayName: 'Deploy to the Dev environment'
    dependsOn: Build
    jobs:
    - template: templates/deploy-kubernetes.yaml
      parameters:
        variableGroup: devops-framework-backend-dev
        environment: dev

- ${{ if and(ne(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.SourceBranchName'], 'release')) }}:
  - stage: DeployPreprod
    displayName: 'Deploy to the Preprod environment'
    dependsOn: Build
    jobs:
    - template: templates/deploy-kubernetes.yaml
      parameters:
        variableGroup: devops-framework-backend-preprod
        environment: preprod
