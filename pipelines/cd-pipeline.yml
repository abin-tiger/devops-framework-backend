trigger:
  batch: false

  branches:
    exclude:
    - 'refs/branches/*'

  tags:
    include:
    - v*

pr: none
  

variables:
  - name: tag
    value: '$(Build.SourceBranchName)'
  - name: semanticVersion
    value: $[ replace(variables['Build.SourceBranchName'], 'v', '') ]
  - group: devops-framework-backend-global

stages:
- stage: 'Build'
  displayName: 'Build the web application'
  jobs: 
  - template: templates/build.yaml
    parameters:
      test: false

- stage: Prod
  displayName: 'Deploy to the Prod environment'
  condition: and(
    succeeded(),
    ne(variables['Build.Reason'], 'PullRequest'),
    startsWith(variables['Build.SourceBranch'], 'refs/tags/')
    )
  dependsOn: Build
  jobs:
  - template: templates/deploy-kubernetes.yaml
    parameters:
      variableGroup: devops-framework-backend-prod
      environment: prod
